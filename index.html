<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>打刻管理</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@200..700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: "Oswald", sans-serif;
      padding: 20px;
      background: #f9f9f9;
    }

    h1 {
      font-size: 20px;
      color: #555;
      margin-bottom: 5px;
    }

    #todayDate {
      font-size: 14px;
      color: #999;
      margin-bottom: 10px;
    }

    #thankYouMessage {
      font-size: 18px;
      color: #e91e63;
      margin: 5px 0 10px;
      font-weight: bold;
    }

    #liveWorkTime {
      font-size: 48px;
      margin: 20px 0;
      color: #333;
    }

    .button-container {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .emoji-button {
      font-size: 28px;
      background: none;
      border: none;
      cursor: pointer;
    }

    #logTable {
      margin-top: 20px;
      border-collapse: collapse;
      min-width: 300px;
    }

    #logTable td {
      color: #666;
      padding: 2px 8px;
      white-space: nowrap;
    }

    #clearBtn {
      font-size: 12px;
      padding: 4px 10px;
      margin-top: 10px;
      color: #444;
      background: #eee;
      border: 1px solid #ccc;
      border-radius: 4px;
      display: none;
      cursor: pointer;
    }

    #clearBtn:hover {
      background: #ddd;
    }
  </style>
</head>
<body>

  <h1>打刻管理</h1>
  <div id="todayDate"></div>
  <div id="thankYouMessage"></div>
  <div id="liveWorkTime">--:--:--</div>

  <div class="button-container">
    <button id="startPauseBtn" class="emoji-button" onclick="handleStartPause()">▶️</button>
    <button id="endBtn" class="emoji-button" onclick="endWork()" style="display: none;">⏹️</button>
  </div>

  <table id="logTable">
    <tbody id="logBody"></tbody>
  </table>

  <button id="clearBtn" onclick="clearLog()">クリア</button>

  <script>
    let log = [];
    let pauseStart = null;
    let totalBreak = 0;
    let clockInTime = null;
    let clockOutTime = null;
    let inBreak = false;
    let currentPhase = 'notStarted';
    let lastDisplayed = '';

    function formatTimeShort(date) {
      return date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
    }

    function formatLogDateTime(date) {
      return date.toLocaleString('ja-JP', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit'
      });
    }

    function formatSecondsToHMS(sec) {
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      return `${h > 0 ? h + '時間' : ''}${m}分`;
    }

    function formatSeconds(sec) {
      const h = String(Math.floor(sec / 3600)).padStart(2, '0');
      const m = String(Math.floor((sec % 3600) / 60)).padStart(2, '0');
      const s = String(sec % 60).padStart(2, '0');
      return `${h}:${m}:${s}`;
    }

    function addLog(message) {
      const now = new Date();
      const row = document.createElement('tr');
      row.innerHTML = `<td>${formatLogDateTime(now)}</td><td>${message}</td>`;
      document.getElementById('logBody').appendChild(row);
      log.push(`${formatLogDateTime(now)}\t${message}`);
      document.getElementById('clearBtn').style.display = 'inline-block';
      saveState();
    }

    function updateLiveTime() {
      const now = new Date();
      if (clockInTime && !clockOutTime) {
        let elapsed = Math.floor((now - clockInTime) / 1000);
        let breakNow = inBreak && pauseStart ? Math.floor((now - pauseStart) / 1000) : 0;
        const actualElapsed = elapsed - (totalBreak + breakNow);
        const displayTime = formatSeconds(actualElapsed);
        if (!inBreak && displayTime !== lastDisplayed) {
          document.getElementById('liveWorkTime').textContent = displayTime;
          lastDisplayed = displayTime;
        }
      }
      requestAnimationFrame(updateLiveTime);
    }

    function handleStartPause() {
      const icon = document.getElementById('startPauseBtn');
      const endBtn = document.getElementById('endBtn');

      if (currentPhase === 'notStarted') {
        clockInTime = new Date();
        addLog('開始');
        currentPhase = 'working';
        icon.textContent = "⏸️";
        endBtn.style.display = 'inline-block';
        document.getElementById('thankYouMessage').textContent = '';
      } else if (currentPhase === 'working') {
        pauseStart = new Date();
        inBreak = true;
        currentPhase = 'paused';
        icon.textContent = "▶️";
        addLog('一時停止');
      } else if (currentPhase === 'paused') {
        const now = new Date();
        const breakSec = Math.floor((now - pauseStart) / 1000);
        totalBreak += breakSec;
        pauseStart = null;
        inBreak = false;
        currentPhase = 'working';
        icon.textContent = "⏸️";
        addLog(`再開（休憩: ${formatSecondsToHMS(breakSec)}）`);
      }
      saveState();
    }

    function endWork() {
      const icon = document.getElementById('startPauseBtn');
      clockOutTime = new Date();
      if (inBreak && pauseStart) {
        totalBreak += Math.floor((clockOutTime - pauseStart) / 1000);
        pauseStart = null;
        inBreak = false;
      }
      addLog('終了');
      const elapsed = Math.floor((clockOutTime - clockInTime) / 1000);
      const actualElapsed = elapsed - totalBreak;
      const workTimeStr = formatSecondsToHMS(actualElapsed);
      currentPhase = 'notStarted';
      icon.textContent = "▶️";
      document.getElementById('endBtn').style.display = 'none';
      document.getElementById('thankYouMessage').textContent = `お疲れさまでした！累計労働時間：${workTimeStr}`;
      saveState();
    }

    function clearLog() {
      if (confirm("ログをすべて削除してもよろしいですか？")) {
        log = [];
        pauseStart = null;
        totalBreak = 0;
        clockInTime = null;
        clockOutTime = null;
        inBreak = false;
        currentPhase = 'notStarted';
        document.getElementById('logBody').innerHTML = '';
        document.getElementById('liveWorkTime').textContent = '--:--:--';
        document.getElementById('startPauseBtn').textContent = "▶️";
        document.getElementById('endBtn').style.display = 'none';
        document.getElementById('clearBtn').style.display = 'none';
        document.getElementById('thankYouMessage').textContent = '';
        localStorage.removeItem('dakcokuState');
      }
    }

    function updateTodayDate() {
      const now = new Date();
      const dateStr = now.toLocaleDateString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        weekday: 'short'
      });
      const timeStr = now.toLocaleTimeString('ja-JP', {
        hour: '2-digit',
        minute: '2-digit'
      });
      document.getElementById('todayDate').textContent = `本日：${dateStr}　${timeStr}`;
    }

    function saveState() {
      const state = {
        clockInTime,
        clockOutTime,
        pauseStart,
        totalBreak,
        inBreak,
        currentPhase,
        log
      };
      localStorage.setItem('dakcokuState', JSON.stringify(state));
    }

    function loadState() {
      const saved = localStorage.getItem('dakcokuState');
      if (!saved) return;
      const state = JSON.parse(saved);
      clockInTime = state.clockInTime ? new Date(state.clockInTime) : null;
      clockOutTime = state.clockOutTime ? new Date(state.clockOutTime) : null;
      pauseStart = state.pauseStart ? new Date(state.pauseStart) : null;
      totalBreak = state.totalBreak;
      inBreak = state.inBreak;
      currentPhase = state.currentPhase;
      log = state.log || [];

      const logBody = document.getElementById('logBody');
      logBody.innerHTML = '';
      log.forEach(entry => {
        const [dateStr, message] = entry.split('\t');
        const row = document.createElement('tr');
        row.innerHTML = `<td>${dateStr}</td><td>${message}</td>`;
        logBody.appendChild(row);
      });

      if (log.length > 0) {
        document.getElementById('clearBtn').style.display = 'inline-block';
      }

      const icon = document.getElementById('startPauseBtn');
      icon.textContent = (currentPhase === 'paused') ? "▶️" :
                         (currentPhase === 'working') ? "⏸️" : "▶️";
      document.getElementById('endBtn').style.display = (currentPhase === 'notStarted') ? 'none' : 'inline-block';
    }

    loadState();
    updateTodayDate();
    setInterval(updateTodayDate, 60000);
    requestAnimationFrame(updateLiveTime);
  </script>
</body>
</html>
